#!/usr/bin/env node

/**
 * Sistema Principal de Gera√ß√£o de C√≥digo
 * TecnoCursos AI - Main Code Generation System
 *
 * Orquestra todos os geradores de c√≥digo:
 * - Componentes React
 * - APIs FastAPI
 * - Modelos de Banco
 * - Testes Automatizados
 * - Documenta√ß√£o
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Importar todos os geradores
const {
  generateComponent,
  CONFIG: componentsConfig,
} = require('./generateComponents');
const { generateAPI, CONFIG: apiConfig } = require('./generateAPI');
const { generateModel, CONFIG: databaseConfig } = require('./generateDatabase');
const { generateTests, CONFIG: testsConfig } = require('./generateTests');
const { generateDocumentation, CONFIG: docsConfig } = require('./generateDocs');

/**
 * Configura√ß√£o principal do sistema
 */
const MAIN_CONFIG = {
  projectRoot: path.resolve(__dirname, '../..'),
  scriptsDir: path.resolve(__dirname, '.'),
  outputDir: path.resolve(__dirname, '../../generated'),
  prettierConfig: path.resolve(__dirname, '../../.prettierrc'),
};

/**
 * Utilit√°rio para executar comandos
 */
const runCommand = (command, cwd = MAIN_CONFIG.projectRoot) => {
  try {
    console.log(`üîÑ Executando: ${command}`);
    execSync(command, {
      cwd,
      stdio: 'inherit',
      encoding: 'utf8',
    });
    return true;
  } catch (error) {
    console.error(`‚ùå Erro ao executar: ${command}`);
    console.error(error.message);
    return false;
  }
};

/**
 * Verificar depend√™ncias
 */
const checkDependencies = () => {
  console.log('üîç Verificando depend√™ncias...');

  const requiredPackages = [
    'prettier',
    '@testing-library/react',
    '@testing-library/jest-dom',
    'fastapi',
    'sqlalchemy',
    'alembic',
  ];

  const missingPackages = [];

  for (const pkg of requiredPackages) {
    try {
      require.resolve(pkg);
    } catch (error) {
      missingPackages.push(pkg);
    }
  }

  if (missingPackages.length > 0) {
    console.warn(`‚ö†Ô∏è  Pacotes faltando: ${missingPackages.join(', ')}`);
    console.log('üí° Execute: npm install para instalar depend√™ncias');
    return false;
  }

  console.log('‚úÖ Todas as depend√™ncias est√£o instaladas');
  return true;
};

/**
 * Limpar arquivos gerados anteriormente
 */
const cleanupGeneratedFiles = () => {
  console.log('üßπ Limpando arquivos gerados anteriormente...');

  const dirsToClean = [
    componentsConfig.outputDir,
    apiConfig.outputDir,
    databaseConfig.outputDir,
    testsConfig.outputDir,
    docsConfig.outputDir,
    MAIN_CONFIG.outputDir,
  ];

  for (const dir of dirsToClean) {
    if (fs.existsSync(dir)) {
      fs.rmSync(dir, { recursive: true, force: true });
      console.log(`üóëÔ∏è  Limpo: ${dir}`);
    }
  }
};

/**
 * Gerar todos os componentes React
 */
const generateAllComponents = async () => {
  console.log('\nüì¶ Gerando componentes React...');

  const componentConfigs = [
    {
      name: 'DataTable',
      description: 'Componente de tabela de dados com pagina√ß√£o e ordena√ß√£o',
      props: [
        {
          name: 'data',
          type: 'any[]',
          description: 'Dados para exibir na tabela',
        },
        {
          name: 'columns',
          type: 'Column[]',
          description: 'Configura√ß√£o das colunas',
        },
        {
          name: 'onRowClick',
          type: '(row: any) => void',
          description: 'Callback para clique na linha',
        },
        {
          name: 'loading',
          type: 'boolean',
          description: 'Estado de carregamento',
        },
      ],
      imports: [
        "import { useState, useMemo } from 'react';",
        "import { ChevronUpIcon, ChevronDownIcon } from '@heroicons/react/24/outline';",
      ],
    },
    {
      name: 'Modal',
      description: 'Componente de modal reutiliz√°vel',
      props: [
        {
          name: 'isOpen',
          type: 'boolean',
          description: 'Estado de abertura do modal',
        },
        {
          name: 'onClose',
          type: '() => void',
          description: 'Callback para fechar o modal',
        },
        { name: 'title', type: 'string', description: 'T√≠tulo do modal' },
        {
          name: 'children',
          type: 'React.ReactNode',
          description: 'Conte√∫do do modal',
        },
      ],
      imports: [
        "import { useEffect } from 'react';",
        "import { XMarkIcon } from '@heroicons/react/24/outline';",
      ],
    },
    {
      name: 'FormField',
      description: 'Campo de formul√°rio com valida√ß√£o',
      props: [
        { name: 'label', type: 'string', description: 'R√≥tulo do campo' },
        { name: 'value', type: 'string', description: 'Valor do campo' },
        {
          name: 'onChange',
          type: '(value: string) => void',
          description: 'Callback de mudan√ßa',
        },
        { name: 'error', type: 'string', description: 'Mensagem de erro' },
        {
          name: 'type',
          type: "'text' | 'email' | 'password'",
          description: 'Tipo do campo',
        },
      ],
      imports: [
        "import { useState } from 'react';",
        "import { EyeIcon, EyeSlashIcon } from '@heroicons/react/24/outline';",
      ],
    },
    {
      name: 'Notification',
      description: 'Sistema de notifica√ß√µes',
      props: [
        {
          name: 'message',
          type: 'string',
          description: 'Mensagem da notifica√ß√£o',
        },
        {
          name: 'type',
          type: "'success' | 'error' | 'warning' | 'info'",
          description: 'Tipo da notifica√ß√£o',
        },
        {
          name: 'onClose',
          type: '() => void',
          description: 'Callback para fechar',
        },
        {
          name: 'autoClose',
          type: 'boolean',
          description: 'Fechar automaticamente',
        },
      ],
      imports: [
        "import { useEffect } from 'react';",
        "import { XMarkIcon, CheckCircleIcon, ExclamationTriangleIcon, InformationCircleIcon } from '@heroicons/react/24/outline';",
      ],
    },
    {
      name: 'Pagination',
      description: 'Componente de pagina√ß√£o',
      props: [
        { name: 'currentPage', type: 'number', description: 'P√°gina atual' },
        { name: 'totalPages', type: 'number', description: 'Total de p√°ginas' },
        {
          name: 'onPageChange',
          type: '(page: number) => void',
          description: 'Callback de mudan√ßa de p√°gina',
        },
        {
          name: 'showPageNumbers',
          type: 'boolean',
          description: 'Mostrar n√∫meros das p√°ginas',
        },
      ],
      imports: [
        "import { ChevronLeftIcon, ChevronRightIcon } from '@heroicons/react/24/outline';",
      ],
    },
  ];

  for (const config of componentConfigs) {
    console.log(`  üì¶ Gerando: ${config.name}`);
    await generateComponent(config);
  }
};

/**
 * Gerar todas as APIs
 */
const generateAllAPIs = async () => {
  console.log('\nüåê Gerando APIs...');

  const apiConfigs = [
    {
      name: 'Project',
      description: 'API para gerenciamento de projetos',
      operations: ['list', 'get', 'create', 'update', 'delete'],
    },
    {
      name: 'Video',
      description: 'API para gerenciamento de v√≠deos',
      operations: ['list', 'get', 'create', 'update', 'delete'],
    },
    {
      name: 'Scene',
      description: 'API para gerenciamento de cenas',
      operations: ['list', 'get', 'create', 'update', 'delete'],
    },
    {
      name: 'Asset',
      description: 'API para gerenciamento de assets',
      operations: ['list', 'get', 'create', 'update', 'delete'],
    },
    {
      name: 'User',
      description: 'API para gerenciamento de usu√°rios',
      operations: ['list', 'get', 'create', 'update', 'delete'],
    },
  ];

  for (const config of apiConfigs) {
    console.log(`  üåê Gerando: ${config.name}`);
    await generateAPI(config);
  }
};

/**
 * Gerar todos os modelos de banco
 */
const generateAllModels = async () => {
  console.log('\nüóÑÔ∏è  Gerando modelos de banco...');

  const modelConfigs = [
    {
      name: 'Project',
      description: 'Modelo para projetos de v√≠deo',
      fields: [
        {
          name: 'name',
          type: 'string',
          length: 255,
          description: 'Nome do projeto',
        },
        {
          name: 'description',
          type: 'text',
          description: 'Descri√ß√£o do projeto',
        },
        {
          name: 'status',
          type: 'string',
          length: 50,
          description: 'Status do projeto',
        },
        {
          name: 'is_active',
          type: 'boolean',
          default: true,
          description: 'Projeto ativo',
        },
      ],
    },
    {
      name: 'Video',
      description: 'Modelo para v√≠deos',
      fields: [
        {
          name: 'title',
          type: 'string',
          length: 255,
          description: 'T√≠tulo do v√≠deo',
        },
        {
          name: 'description',
          type: 'text',
          description: 'Descri√ß√£o do v√≠deo',
        },
        { name: 'duration', type: 'float', description: 'Dura√ß√£o em segundos' },
        {
          name: 'file_path',
          type: 'string',
          length: 500,
          description: 'Caminho do arquivo',
        },
        {
          name: 'project_id',
          type: 'foreign_key',
          reference_table: 'projects',
          reference_model: 'Project',
          description: 'Projeto relacionado',
        },
      ],
    },
    {
      name: 'Scene',
      description: 'Modelo para cenas de v√≠deo',
      fields: [
        {
          name: 'title',
          type: 'string',
          length: 255,
          description: 'T√≠tulo da cena',
        },
        { name: 'duration', type: 'float', description: 'Dura√ß√£o da cena' },
        { name: 'order', type: 'integer', description: 'Ordem da cena' },
        {
          name: 'video_id',
          type: 'foreign_key',
          reference_table: 'videos',
          reference_model: 'Video',
          description: 'V√≠deo relacionado',
        },
      ],
    },
    {
      name: 'Asset',
      description: 'Modelo para assets (imagens, √°udios, etc.)',
      fields: [
        {
          name: 'name',
          type: 'string',
          length: 255,
          description: 'Nome do asset',
        },
        {
          name: 'type',
          type: 'string',
          length: 50,
          description: 'Tipo do asset',
        },
        {
          name: 'file_path',
          type: 'string',
          length: 500,
          description: 'Caminho do arquivo',
        },
        { name: 'size', type: 'integer', description: 'Tamanho em bytes' },
        {
          name: 'scene_id',
          type: 'foreign_key',
          reference_table: 'scenes',
          reference_model: 'Scene',
          description: 'Cena relacionada',
        },
      ],
    },
    {
      name: 'User',
      description: 'Modelo para usu√°rios',
      fields: [
        {
          name: 'username',
          type: 'string',
          length: 100,
          description: 'Nome de usu√°rio',
        },
        {
          name: 'email',
          type: 'string',
          length: 255,
          description: 'Email do usu√°rio',
        },
        {
          name: 'password_hash',
          type: 'string',
          length: 255,
          description: 'Hash da senha',
        },
        {
          name: 'is_active',
          type: 'boolean',
          default: true,
          description: 'Usu√°rio ativo',
        },
        { name: 'last_login', type: 'datetime', description: '√öltimo login' },
      ],
    },
  ];

  for (const config of modelConfigs) {
    console.log(`  üóÑÔ∏è  Gerando: ${config.name}`);
    await generateModel(config);
  }
};

/**
 * Gerar todos os testes
 */
const generateAllTests = async () => {
  console.log('\nüß™ Gerando testes...');

  const testConfigs = [
    {
      name: 'Toolbar',
      type: 'react',
      description: 'Testes para componente Toolbar',
      props: [
        {
          name: 'onUndo',
          type: 'function',
          description: 'Callback para desfazer',
        },
        {
          name: 'onRedo',
          type: 'function',
          description: 'Callback para refazer',
        },
        {
          name: 'canUndo',
          type: 'boolean',
          description: 'Estado de habilita√ß√£o desfazer',
        },
        {
          name: 'canRedo',
          type: 'boolean',
          description: 'Estado de habilita√ß√£o refazer',
        },
      ],
    },
    {
      name: 'VideoAPI',
      type: 'api',
      description: 'Testes para API de v√≠deos',
      endpoints: [
        {
          method: 'GET',
          name: 'list_videos',
          path: '/api/videos',
          expectedStatus: 200,
        },
        {
          method: 'POST',
          name: 'create_video',
          path: '/api/videos',
          expectedStatus: 201,
          sampleData: { title: 'Test Video', description: 'Test Description' },
        },
        {
          method: 'GET',
          name: 'get_video',
          path: '/api/videos/{id}',
          expectedStatus: 200,
        },
        {
          method: 'PUT',
          name: 'update_video',
          path: '/api/videos/{id}',
          expectedStatus: 200,
          updateData: { title: 'Updated Video' },
        },
        {
          method: 'DELETE',
          name: 'delete_video',
          path: '/api/videos/{id}',
          expectedStatus: 204,
        },
      ],
    },
    {
      name: 'VideoModel',
      type: 'database',
      description: 'Testes para modelo de v√≠deo',
      fields: [
        { name: 'title', type: 'string', description: 'T√≠tulo do v√≠deo' },
        {
          name: 'description',
          type: 'string',
          description: 'Descri√ß√£o do v√≠deo',
        },
        {
          name: 'duration',
          type: 'integer',
          description: 'Dura√ß√£o em segundos',
        },
        { name: 'is_active', type: 'boolean', description: 'V√≠deo ativo' },
      ],
    },
    {
      name: 'VideoWorkflow',
      type: 'integration',
      description: 'Testes de integra√ß√£o para workflow de v√≠deo',
      scenarios: [
        {
          name: 'create_and_process_video',
          description: 'Criar e processar um v√≠deo completo',
          setup: [
            'video_data = {"title": "Test Video", "description": "Test Description"}',
            'project_data = {"name": "Test Project", "description": "Test Project Description"}',
          ],
          execute: [
            'project_response = self.client.post("/api/projects", json=project_data)',
            'project_id = project_response.json()["id"]',
            'video_data["project_id"] = project_id',
            'video_response = self.client.post("/api/videos", json=video_data)',
          ],
          assert: [
            'self.assertEqual(video_response.status_code, 201)',
            'self.assertIn("id", video_response.json())',
            'self.assertEqual(video_response.json()["title"], "Test Video")',
          ],
        },
      ],
    },
  ];

  for (const config of testConfigs) {
    console.log(`  üß™ Gerando: ${config.name} (${config.type})`);
    await generateTests(config);
  }
};

/**
 * Gerar toda a documenta√ß√£o
 */
const generateAllDocs = async () => {
  console.log('\nüìö Gerando documenta√ß√£o...');

  const docConfigs = [
    {
      name: 'VideoAPI',
      type: 'openapi',
      description: 'Documenta√ß√£o OpenAPI para API de v√≠deos',
      endpoints: [
        {
          method: 'GET',
          name: 'list_videos',
          path: '/api/videos',
          summary: 'Lista todos os v√≠deos',
          description: 'Retorna uma lista paginada de v√≠deos',
          parameters: [
            {
              name: 'skip',
              in: 'query',
              type: 'integer',
              description: 'N√∫mero de registros para pular',
            },
            {
              name: 'limit',
              in: 'query',
              type: 'integer',
              description: 'N√∫mero m√°ximo de registros',
            },
          ],
        },
        {
          method: 'POST',
          name: 'create_video',
          path: '/api/videos',
          summary: 'Cria um novo v√≠deo',
          description: 'Cria um novo v√≠deo com os dados fornecidos',
        },
        {
          method: 'GET',
          name: 'get_video',
          path: '/api/videos/{id}',
          summary: 'Obt√©m um v√≠deo espec√≠fico',
          description: 'Retorna os detalhes de um v√≠deo espec√≠fico',
        },
        {
          method: 'PUT',
          name: 'update_video',
          path: '/api/videos/{id}',
          summary: 'Atualiza um v√≠deo',
          description: 'Atualiza os dados de um v√≠deo espec√≠fico',
        },
        {
          method: 'DELETE',
          name: 'delete_video',
          path: '/api/videos/{id}',
          summary: 'Remove um v√≠deo',
          description: 'Remove um v√≠deo espec√≠fico',
        },
      ],
    },
    {
      name: 'Toolbar',
      type: 'react',
      description: 'Documenta√ß√£o do componente Toolbar',
      props: [
        {
          name: 'onUndo',
          type: 'function',
          required: false,
          description: 'Callback para desfazer a√ß√£o',
        },
        {
          name: 'onRedo',
          type: 'function',
          required: false,
          description: 'Callback para refazer a√ß√£o',
        },
        {
          name: 'canUndo',
          type: 'boolean',
          required: false,
          default: false,
          description: 'Estado de habilita√ß√£o desfazer',
        },
        {
          name: 'canRedo',
          type: 'boolean',
          required: false,
          default: false,
          description: 'Estado de habilita√ß√£o refazer',
        },
      ],
    },
    {
      name: 'Video',
      type: 'database',
      description: 'Documenta√ß√£o do modelo Video',
      fields: [
        {
          name: 'title',
          type: 'string',
          nullable: false,
          description: 'T√≠tulo do v√≠deo',
        },
        {
          name: 'description',
          type: 'text',
          nullable: true,
          description: 'Descri√ß√£o do v√≠deo',
        },
        {
          name: 'duration',
          type: 'float',
          nullable: true,
          description: 'Dura√ß√£o em segundos',
        },
        {
          name: 'file_path',
          type: 'string',
          nullable: false,
          description: 'Caminho do arquivo',
        },
        {
          name: 'is_active',
          type: 'boolean',
          nullable: false,
          default: true,
          description: 'V√≠deo ativo',
        },
      ],
    },
    {
      name: 'TecnoCursosAI',
      type: 'architecture',
      description: 'Documenta√ß√£o da arquitetura do sistema',
      components: [
        {
          id: 'frontend',
          name: 'Frontend React',
          description: 'Interface do usu√°rio constru√≠da com React',
          technologies: ['React', 'TypeScript', 'Tailwind CSS'],
          responsibilities: [
            'Renderiza√ß√£o de componentes',
            'Gerenciamento de estado',
            'Intera√ß√£o com API',
          ],
        },
        {
          id: 'backend',
          name: 'Backend FastAPI',
          description: 'API REST constru√≠da com FastAPI',
          technologies: ['FastAPI', 'SQLAlchemy', 'Pydantic'],
          responsibilities: [
            'Processamento de requisi√ß√µes',
            'Valida√ß√£o de dados',
            'L√≥gica de neg√≥cio',
          ],
        },
        {
          id: 'database',
          name: 'Banco de Dados',
          description: 'Armazenamento persistente de dados',
          technologies: ['PostgreSQL', 'SQLAlchemy', 'Alembic'],
          responsibilities: [
            'Persist√™ncia de dados',
            'Relacionamentos',
            'Migra√ß√µes',
          ],
        },
        {
          id: 'cache',
          name: 'Cache Redis',
          description: 'Cache em mem√≥ria para performance',
          technologies: ['Redis'],
          responsibilities: [
            'Cache de sess√µes',
            'Cache de dados',
            'Filas de processamento',
          ],
        },
      ],
    },
  ];

  for (const config of docConfigs) {
    console.log(`  üìö Gerando: ${config.name} (${config.type})`);
    await generateDocumentation(config);
  }
};

/**
 * Executar formata√ß√£o de c√≥digo
 */
const formatCode = () => {
  console.log('\nüé® Formatando c√≥digo...');

  const success = runCommand('npx prettier --write "src/**/*.{js,jsx,ts,tsx}"');

  if (success) {
    console.log('‚úÖ C√≥digo formatado com sucesso');
  } else {
    console.warn('‚ö†Ô∏è  Erro ao formatar c√≥digo');
  }
};

/**
 * Executar testes
 */
const runTests = () => {
  console.log('\nüß™ Executando testes...');

  const success = runCommand('npm test -- --passWithNoTests');

  if (success) {
    console.log('‚úÖ Testes executados com sucesso');
  } else {
    console.warn('‚ö†Ô∏è  Alguns testes falharam');
  }
};

/**
 * Gerar relat√≥rio final
 */
const generateReport = () => {
  console.log('\nüìä Gerando relat√≥rio final...');

  const report = {
    timestamp: new Date().toISOString(),
    generated: {
      components: 5,
      apis: 5,
      models: 5,
      tests: 4,
      docs: 4,
    },
    totalFiles: 23,
    status: 'success',
  };

  const reportPath = path.join(MAIN_CONFIG.outputDir, 'generation-report.json');
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));

  console.log('üìä Relat√≥rio gerado:', reportPath);
  console.log(`üìà Total de arquivos gerados: ${report.totalFiles}`);
};

/**
 * Fun√ß√£o principal
 */
const main = async () => {
  console.log('üöÄ Sistema de Gera√ß√£o de C√≥digo TecnoCursos AI');
  console.log('='.repeat(50));

  try {
    // Verificar depend√™ncias
    if (!checkDependencies()) {
      console.log('üí° Execute: npm install para instalar depend√™ncias');
      return;
    }

    // Limpar arquivos anteriores
    cleanupGeneratedFiles();

    // Gerar todos os componentes
    await generateAllComponents();

    // Gerar todas as APIs
    await generateAllAPIs();

    // Gerar todos os modelos
    await generateAllModels();

    // Gerar todos os testes
    await generateAllTests();

    // Gerar toda a documenta√ß√£o
    await generateAllDocs();

    // Formatar c√≥digo
    formatCode();

    // Executar testes
    runTests();

    // Gerar relat√≥rio
    generateReport();

    console.log('\nüéâ Gera√ß√£o conclu√≠da com sucesso!');
    console.log('üìÅ Arquivos gerados em:', MAIN_CONFIG.outputDir);
    console.log('üí° Execute: npm start para iniciar o projeto');
  } catch (error) {
    console.error('‚ùå Erro durante a gera√ß√£o:', error);
    process.exit(1);
  }
};

// Executar se chamado diretamente
if (require.main === module) {
  main();
}

module.exports = {
  main,
  generateAllComponents,
  generateAllAPIs,
  generateAllModels,
  generateAllTests,
  generateAllDocs,
  MAIN_CONFIG,
};
