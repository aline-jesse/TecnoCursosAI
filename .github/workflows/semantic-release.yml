name: ğŸš€ Semantic Release

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ============================================================================
  # VALIDAÃ‡ÃƒO DE COMMITS
  # ============================================================================
  validate-commits:
    name: âœ… Validar Commits
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ” Validar commits
      run: |
        npx commitlint --from HEAD~10 --to HEAD --verbose
        echo "âœ… Commits validados com sucesso"
    
    - name: ğŸ¨ Verificar formataÃ§Ã£o
      run: |
        npm run format:check
        echo "âœ… FormataÃ§Ã£o verificada"
    
    - name: ğŸ”§ Verificar linting
      run: |
        npm run lint
        echo "âœ… Linting verificado"

  # ============================================================================
  # SEMANTIC RELEASE
  # ============================================================================
  semantic-release:
    name: ğŸš€ Semantic Release
    runs-on: ubuntu-latest
    needs: validate-commits
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        registry-url: 'https://npm.pkg.github.com'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ§ª Executar testes
      run: |
        npm run test:ci
        echo "âœ… Testes executados"
    
    - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
      run: |
        npm run build
        echo "âœ… Build concluÃ­do"
    
    - name: ğŸš€ Executar Semantic Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: |
        npx semantic-release
        echo "âœ… Semantic release executado"
    
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: release-artifacts
        path: |
          dist/
          build/
          CHANGELOG.md

  # ============================================================================
  # NOTIFICAÃ‡Ã•ES
  # ============================================================================
  notify-release:
    name: ğŸ“¢ Notificar Release
    runs-on: ubuntu-latest
    needs: semantic-release
    if: always() && needs.semantic-release.result == 'success'
    
    steps:
    - name: ğŸ’¬ Notificar Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#releases'
        text: 'ğŸ‰ Nova versÃ£o lanÃ§ada automaticamente!'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: ğŸ“§ Notificar equipe
      run: |
        echo "ğŸ“§ Enviando notificaÃ§Ã£o por email..."
        # Aqui seria implementada a lÃ³gica de notificaÃ§Ã£o por email

  # ============================================================================
  # DEPLOY AUTOMÃTICO
  # ============================================================================
  auto-deploy:
    name: ğŸš€ Deploy AutomÃ¡tico
    runs-on: ubuntu-latest
    needs: semantic-release
    if: needs.semantic-release.result == 'success'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy para produÃ§Ã£o
      run: |
        echo "ğŸš€ Iniciando deploy automÃ¡tico..."
        # Aqui seria implementada a lÃ³gica de deploy
        echo "âœ… Deploy concluÃ­do com sucesso"
    
    - name: ğŸ” Health check
      run: |
        echo "ğŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
        # Aqui seria implementada a verificaÃ§Ã£o de saÃºde
        echo "âœ… AplicaÃ§Ã£o saudÃ¡vel"
    
    - name: ğŸ“Š Atualizar mÃ©tricas
      run: |
        echo "ğŸ“Š Atualizando mÃ©tricas de deploy..."
        # Aqui seria implementada a atualizaÃ§Ã£o de mÃ©tricas 